@if (
	{
		options: (options$ | async) || [],
		groupTemplateLocation: groupTemplateLocation$ | async,
		shouldDisplayAddOption: shouldDisplayAddOption$ | async,
	};
	as ctx
) {
	<div class="lu-picker-panel lu-option-picker-panel" cdkTrapFocus>
		<div class="lu-picker-content" [class.is-loading]="loading$ | async" (scroll)="onScroll($event)">
			@if (selectInput.panelHeaderTpl(); as tpl) {
				<div>
					<ng-container *luPortal="tpl" />
				</div>
			}
			@let loading = loading$ | async;
			@let empty = !loading && ctx.options.length === 0;
			@let listboxState = loading ? "loading" : empty ? "empty" : null;
			@let statusMsg = { loading: intl.loading, empty: intl.emptyResults }[listboxState];

			<lu-listbox [state]="listboxState" [statusMsg]="statusMsg" [tree]="!!treeGenerator">
				@if (grouping && ctx.groupTemplateLocation === "group-header") {
					@for (group of ctx.options | luOptionGroup: grouping.selector; track trackGroupsBy(groupIndex, group); let groupIndex = $index) {
						<lu-listbox-option group> <ng-container *luPortal="grouping.content; context: { $implicit: group }" /> </lu-listbox-option>
						<ng-template
							[ngTemplateOutlet]="optionsList"
							[ngTemplateOutletContext]="{ $implicit: group.options, groupIndex: groupIndex }"
						/>
					}
				}
				@if (!grouping || ctx.groupTemplateLocation !== "group-header") {
					<ng-template [ngTemplateOutlet]="optionsList" [ngTemplateOutletContext]="{ $implicit: ctx.options }" />
				}
				<ng-template #optionsList let-options let-groupIndex="groupIndex">
					@if (treeGenerator) {
						@for (branch of options | luTreeDisplay: treeGenerator; let index = $index; track trackBranchesBy(index, branch)) {
							<lu-tree-branch
								[branch]="branch"
								[optionTpl]="optionTpl()"
								[optionComparer]="optionComparer"
								[selectedOptions]="[selected()]"
								[optionIndex]="index"
								(toggleOne)="panelRef.emitValue($event)"
								simpleMode
							/>
						}
					} @else {
						@for (option of options; track trackOptionsBy(index, option); let index = $index) {
							<lu-select-option
								[option]="option"
								[optionTpl]="optionTpl()"
								[optionIndex]="index"
								[groupTemplateLocation]="ctx.groupTemplateLocation"
								[groupIndex]="groupIndex"
								[grouping]="grouping"
								[scrollIntoViewOptions]="{ block: 'center' }"
								[isSelected]="option | luIsOptionSelected: optionComparer : selected()"
								[class.withAddOption]="ctx.shouldDisplayAddOption"
								(selected)="panelRef.emitValue(option)"
								(click)="panelRef.emitValue(option)"
							/>
						}
					}
				</ng-template>
				@if (ctx.shouldDisplayAddOption) {
					<lu-listbox-option (click)="selectInput.emitAddOption()" (selected)="selectInput.emitAddOption()" add luCoreSelectPanelElement>
						<ng-container *luPortal="selectInput.addOptionLabel" />
					</lu-listbox-option>
				}
			</lu-listbox>
		</div>
	</div>
}
