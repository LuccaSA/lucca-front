@if (
	{
		options: (options$ | async) || [],
		groupTemplateLocation: groupTemplateLocation$ | async,
		shouldDisplayAddOption: shouldDisplayAddOption$ | async,
	};
	as ctx
) {
	<div class="lu-picker-panel lu-option-picker-panel" cdkTrapFocus>
		<div class="lu-picker-content" [class.is-loading]="loading$ | async" (scroll)="onScroll($event)">
			@if (selectInput.panelHeaderTpl(); as tpl) {
				<div>
					<ng-container *luPortal="tpl" />
				</div>
			}
			@let loading = loading$ | async;
			@let empty = !loading && ctx.options.length === 0;
			@let listboxState = loading ? "loading" : empty ? "empty" : null;
			@let statusMsg = { loading: intl.loading, empty: intl.emptyResults }[listboxState];
			<lu-listbox [state]="listboxState" [statusMsg]="statusMsg" [tree]="!!treeGenerator" multiple>
				@if (grouping && ctx.groupTemplateLocation === "group-header") {
					@for (group of ctx.options | luOptionGroup: grouping.selector; track trackGroupsBy(groupIndex, group); let groupIndex = $index) {
						<lu-listbox-option group> <ng-container *luPortal="grouping.content; context: { $implicit: group }" /> </lu-listbox-option>
						<ng-template
							[ngTemplateOutlet]="optionsList"
							[ngTemplateOutletContext]="{ $implicit: group.options, groupIndex: groupIndex }"
						/>
					}
				}
				@if (!grouping || ctx.groupTemplateLocation !== "group-header") {
					<ng-template [ngTemplateOutlet]="optionsList" [ngTemplateOutletContext]="{ $implicit: ctx.options }" />
				}
				<ng-template #optionsList let-options let-groupIndex="groupIndex">
					@if (treeGenerator) {
						@for (branch of options | luTreeDisplay: treeGenerator; let index = $index; track trackBranchesBy(index, branch)) {
							<lu-tree-branch
								[branch]="branch"
								[optionTpl]="optionTpl()"
								[optionComparer]="optionComparer"
								[selectedOptions]="selectedOptions"
								[optionIndex]="index"
								(toggleOne)="toggleOption($event)"
								(selectMany)="toggleOptions($event, [])"
								(unselectMany)="toggleOptions([], $event)"
							/>
						}
					} @else {
						@for (option of options; track trackOptionsBy(index, option); let index = $index) {
							<lu-select-option
								[option]="option"
								[optionTpl]="optionTpl()"
								[optionIndex]="index"
								[groupTemplateLocation]="ctx.groupTemplateLocation"
								[groupIndex]="groupIndex"
								[grouping]="grouping"
								[scrollIntoViewOptions]="{ block: 'center' }"
								[isSelected]="option | luIsOptionSelected: optionComparer : selectedOptions"
								[class.withAddOption]="ctx.shouldDisplayAddOption"
								(selected)="toggleOption(option)"
								(click)="toggleOption(option)"
							/>
						}
					}
				</ng-template>
				@if (ctx.shouldDisplayAddOption) {
					<lu-listbox-option (click)="selectInput.emitAddOption()" (selected)="selectInput.emitAddOption()" add luCoreSelectPanelElement>
						<ng-container *luPortal="selectInput.addOptionLabel" />
					</lu-listbox-option>
				}
			</lu-listbox>
		</div>
	</div>

	<div class="lu-picker-panel lu-option-picker-panel mod-multiple" data-testid="dialog-panel">
		<lu-listbox [state]="listboxState" [statusMsg]="statusMsg" [tree]="!!treeGenerator" multiple>
			@if (grouping && ctx.groupTemplateLocation === "group-header") {
				@for (group of ctx.options | luOptionGroup: grouping.selector; track trackGroupsBy(groupIndex, group); let groupIndex = $index) {
					<div class="lu-picker-content-group" role="group" attr.aria-labelledby="lu-select-{{ selectId }}-group-{{ groupIndex }}">
						@let groupCtx = group.options | luOptionsGroupContext: selectedOptions : optionComparer;
						<div
							luCoreSelectPanelElement
							elementId="lu-select-{{ selectId }}-group-{{ groupIndex }}"
							class="lu-picker-content-option-group-title"
							role="presentation"
							(selected)="toggleOptions(groupCtx.notSelectedOptions, group.options)"
						>
							<span #groupingTitleRef>
								<ng-container *luPortal="grouping.content; context: { $implicit: group }" />
							</span>

							@if (someGroupOptionEnabled()(group.options)) {
								<button
									type="button"
									class="link"
									(click)="toggleOptions(groupCtx.notSelectedOptions, group.options)"
									[id]="selectId + '-group-' + group.key"
								>
									<span class="pr-u-mask">{{ groupingTitleRef.innerText }}&nbsp;â€“ </span
									>{{ groupCtx.isGroupSelected ? intl.unselectAll : intl.selectAll }}
								</button>
							}
						</div>
						<ng-template
							[ngTemplateOutlet]="optionsList"
							[ngTemplateOutletContext]="{ $implicit: group.options, groupIndex: groupIndex }"
						/>
					</div>
				}
			}
		</lu-listbox>
	</div>
}
